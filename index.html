<!DOCTYPE html>
<html>
<head>
    <title>Pension Planner</title>
    <!-- Include the Roboto font for better appearance -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto&display=swap">
    <!-- Include Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Link to the updated CSS file -->
    <link rel="stylesheet" type="text/css" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <h1>Pension Planner</h1>
        <div class="content">
            <!-- Input and Graph Container -->
            <div class="input-graph-container">
                <!-- Left Form -->
                <div class="form-container form-container-left">
                    <form id="pensionFormLeft">
                        <div class="form-group">
                            <label for="currentAge">Current Age:</label>
                            <input type="number" id="currentAge" name="currentAge" value="50" required>
                        </div>

                        <div class="form-group">
                            <label for="retirementAge">Retirement Age:</label>
                            <input type="number" id="retirementAge" name="retirementAge" value="55" required>
                        </div>

                        <div class="form-group">
                            <label for="endAge">End of Projection Age:</label>
                            <input type="number" id="endAge" name="endAge" value="95" required>
                        </div>

                        <div class="form-group">
                            <label for="currentFund">Current Fund (£):</label>
                            <input type="number" id="currentFund" name="currentFund" value="500000" required>
                        </div>

                        <div class="form-group">
                            <label for="monthlyContribution">Monthly Contribution (£):</label>
                            <input type="number" id="monthlyContribution" name="monthlyContribution" value="1000" required>
                        </div>

                        <!-- New ISA Inputs -->
                        <div class="form-group">
                            <label for="currentISA">ISA Holdings (£):</label>
                            <input type="number" id="currentISA" name="currentISA" value="200000" required>
                        </div>

                        <div class="form-group">
                            <label for="monthlyISAContribution">Monthly ISA Contribution (£):</label>
                            <input type="number" id="monthlyISAContribution" name="monthlyISAContribution" value="250" required>
                        </div>

                        <!-- Add State Pension Input -->
                        <div class="form-group">
                            <label for="currentStatePension">Current State Pension (£):</label>
                            <input type="number" id="currentStatePension" name="currentStatePension" value="10800" required>
                        </div>
                    </form>
                </div>

                <!-- Graph Container -->
                <div class="graph-container">
                    <h2>Results</h2>

                    <p id="expectedTotalIncome" class="centered-text"></p>
                    <p id="taxFreeCashTaken" class="centered-text"></p>
                    <p id="tfcLimitMessage" class="centered-text"></p>

                    <!-- Move the Calculate Button here -->
                    <button type="button" id="calculateButton" onclick="calculatePension()">Calculate</button>
                    <canvas id="fundChart"></canvas>
                    <!-- Add a new canvas element for the income chart -->
                    <canvas id="incomeChart"></canvas>
                </div>

                <!-- Right Form -->
                <div class="form-container form-container-right">
                    <form id="pensionFormRight">
                        <div class="form-group">
                            <label for="fundGrowthPre">Fund Growth Pre Retirement (%):</label>
                            <input type="number" id="fundGrowthPre" name="fundGrowthPre" value="6" required>
                        </div>

                        <div class="form-group">
                            <label for="fundGrowthPost">Fund Growth In Retirement (%):</label>
                            <input type="number" id="fundGrowthPost" name="fundGrowthPost" value="4" required>
                        </div>

                        <div class="form-group">
                            <label for="fundCharges">Fund Charges (%):</label>
                            <input type="number" id="fundCharges" name="fundCharges" value="1" required>
                        </div>

                        <div class="form-group">
                            <label for="taxFreeCashPercent">Tax Free Cash Lump Sum (%):</label>
                            <input type="number" id="taxFreeCashPercent" name="taxFreeCashPercent" value="0" max="25" required>
                        </div>

                        <!-- Add Inflation Inputs -->
                        <div class="form-group">
                            <label for="inflation">Inflation Rate (%):</label>
                            <input type="number" id="inflation" name="inflation" value="2" required>
                        </div>

                        <div class="form-group">
                            <label for="statePensionInflation">State Pension Inflation Rate (%):</label>
                            <input type="number" id="statePensionInflation" name="statePensionInflation" value="2.5" required>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <h2>Cash Flow Table</h2>
        <div class="table-responsive">
            <table id="cashFlowTable">
                <thead>
                    <tr>
                        <th>Age</th>
                        <th>Pension Fund (£)</th>
                        <th>Pension Contribution (£)</th>
                        <th>Net Pension Received (£)</th>
                        <th>State Pension (£)</th>
                        <th>Tax Paid (£)</th>
                        <th>TFC Tax Savings (£)</th>
                        <th>Cumulative TFC Taken (£)</th>
                        <th>Pension Fund Growth (£)</th>
                        <th>Pension Fund Charges (£)</th>
                        <th>ISA Holdings (£)</th>
                        <th>ISA Contributions (£)</th>
                        <th>ISA Withdrawals (£)</th>
                        <th>Total Net Income (£)</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows will be added here dynamically -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        function calculatePension() {
            // Get inputs from the left form
            var currentAge = parseInt(document.getElementById("currentAge").value);
            var retirementAge = parseInt(document.getElementById("retirementAge").value);
            var endAge = parseInt(document.getElementById("endAge").value);
            var currentFund = parseFloat(document.getElementById("currentFund").value);
            var monthlyContribution = parseFloat(document.getElementById("monthlyContribution").value);

            // New ISA inputs
            var currentISA = parseFloat(document.getElementById("currentISA").value);
            var monthlyISAContribution = parseFloat(document.getElementById("monthlyISAContribution").value);

            // Get current state pension from user input
            var currentStatePension = parseFloat(document.getElementById("currentStatePension").value) || 0;
            var statePensionAge = getStatePensionAge(currentAge);

            // Get inputs from the right form
            var fundGrowthPre = parseFloat(document.getElementById("fundGrowthPre").value) / 100;
            var fundGrowthPost = parseFloat(document.getElementById("fundGrowthPost").value) / 100;
            var fundCharges = parseFloat(document.getElementById("fundCharges").value) / 100;
            var taxFreeCashPercent = parseFloat(document.getElementById("taxFreeCashPercent").value) / 100;

            var inflation = parseFloat(document.getElementById("inflation").value) / 100;
            var statePensionInflation = parseFloat(document.getElementById("statePensionInflation").value) / 100;
            var earliestPensionWithdrawalAge = 57;

            // Validate inputs
            if (isNaN(currentAge) || isNaN(retirementAge) || isNaN(endAge) || isNaN(currentFund) || isNaN(monthlyContribution) ||
                isNaN(fundGrowthPre) || isNaN(fundGrowthPost) || isNaN(fundCharges) || isNaN(taxFreeCashPercent) ||
                isNaN(currentISA) || isNaN(monthlyISAContribution) || isNaN(currentStatePension) ||
                isNaN(inflation) || isNaN(statePensionInflation)) {
                alert("Please enter valid numbers in all fields.");
                return;
            }

            if (currentAge >= retirementAge || retirementAge > endAge) {
                alert("Ensure that Current Age < Retirement Age ≤ End of Projection Age.");
                return;
            }

            if (taxFreeCashPercent > 0.25) {
                alert("Tax Free Cash % cannot exceed 25%.");
                return;
            }

            if (monthlyISAContribution * 12 > 20000) {
                alert("Maximum Annual ISA Contribution is £20,000.");
                return;
            }

            var annualContribution = monthlyContribution * 12;
            var annualISAContribution = monthlyISAContribution * 12;

            // Calculate future state pension
            var statePension = calculateStatePension(currentAge, currentStatePension, statePensionInflation);

            // Simulate accumulation phase up to retirement age
            var simulationToRetirement = simulateFundToRetirement(
                currentAge, retirementAge, currentFund, annualContribution, fundGrowthPre, fundCharges,
                currentISA, annualISAContribution
            );

            var fundAtRetirement = simulationToRetirement.fundAtRetirement;
            var ISAAtRetirement = simulationToRetirement.ISAAtRetirement;
            var cashFlowDataAccumulation = simulationToRetirement.cashFlowData;

            // Set initial cumulative TFC and remaining TFC percent
            var cumulativeTFC = 0;
            var remainingTFCPercent = 0.25;

            // Total available funds at retirement
            var totalAvailableFunds = fundAtRetirement + ISAAtRetirement;

            // Find the maximum affordable total net income
            var maxAffordableNetIncome = findMaximumAffordableTotalWithdrawal(
                currentAge, retirementAge, endAge, fundAtRetirement, ISAAtRetirement, fundGrowthPost, fundCharges,
                inflation, remainingTFCPercent, cumulativeTFC, statePensionAge, statePension,
                earliestPensionWithdrawalAge, statePensionInflation, cashFlowDataAccumulation,
                taxFreeCashPercent
            );

            // Display tax-free cash taken at earliest pension withdrawal age
            var expectedTFC = fundAtRetirement * taxFreeCashPercent;
            var maxTFCAmount = 268275;
            var taxFreeCashTaken = Math.min(expectedTFC, maxTFCAmount);

            if (expectedTFC > maxTFCAmount) {
                document.getElementById("tfcLimitMessage").innerHTML = 'TFC Taken at Age ' + earliestPensionWithdrawalAge + ' is limited to the maximum of £268,275.';
            } else {
                document.getElementById("tfcLimitMessage").innerHTML = '';
            }
            document.getElementById("tfcLimitMessage").className = "centered-text";

            document.getElementById("taxFreeCashTaken").innerHTML = 'Tax-Free Cash Lump Sum at Age ' + earliestPensionWithdrawalAge + ': <strong>£' + formatNumber(Math.round(taxFreeCashTaken)) + '</strong>';

            // Display expected net monthly retirement income
            document.getElementById("expectedTotalIncome").innerHTML = 'Total Net Monthly Retirement Income: <strong>£' + formatNumber(Math.round(maxAffordableNetIncome / 12)) + '</strong>';

            // Simulate combined fund
            var simulation = simulateCombinedFund(
                currentAge, retirementAge, endAge, fundAtRetirement, ISAAtRetirement, fundGrowthPost, fundCharges,
                inflation, remainingTFCPercent, cumulativeTFC, statePensionAge, statePension,
                earliestPensionWithdrawalAge, maxAffordableNetIncome, statePensionInflation, cashFlowDataAccumulation,
                taxFreeCashPercent, maxTFCAmount
            );

            // Plot charts and display table
            plotChart(simulation);
            plotIncomeChart(simulation); // New function to plot the income breakdown chart
            displayCashFlowTable(simulation.cashFlowData);

            // Change button label to 'Recalculate' after first click
            document.getElementById("calculateButton").innerText = "Recalculate";
        }

        function simulateFundToRetirement(currentAge, retirementAge, currentFund, annualContribution, fundGrowthPre, fundCharges, currentISA, annualISAContribution) {
            var fund = currentFund;
            var ISA = currentISA;
            var cashFlowData = [];

            // Accumulation phase
            for (var age = currentAge; age < retirementAge; age++) {
                var openingBalance = fund;
                var ISAOpening = ISA;

                // Pension Fund Growth
                var investmentGain = fund * fundGrowthPre;
                var fundChargesTaken = fund * fundCharges;
                fund = fund + investmentGain + annualContribution - fundChargesTaken;

                // ISA Growth
                var ISAGain = ISA * fundGrowthPre;
                var ISAChargesTaken = ISA * fundCharges; // Apply fund charges to ISA
                ISA = ISA + ISAGain + annualISAContribution - ISAChargesTaken;

                // Collect cash flow data
                cashFlowData.push({
                    age: age,
                    openingBalance: openingBalance,
                    contribution: annualContribution,
                    withdrawal: 0,
                    statePension: 0,
                    taxPaid: 0,
                    taxSaved: 0,
                    cumulativeTFC: 0,
                    investmentReturn: investmentGain,
                    fundCharges: fundChargesTaken,
                    closingBalance: fund,
                    ISAholdings: ISA,
                    ISAContribution: annualISAContribution,
                    ISADrawings: 0
                });
            }

            return {
                fundAtRetirement: fund,
                ISAAtRetirement: ISA,
                cashFlowData: cashFlowData
            };
        }


        function findMaximumAffordableTotalWithdrawal(
            currentAge, retirementAge, endAge, fundAtRetirement, ISAAtRetirement, fundGrowthPost, fundCharges,
            inflation, remainingTFCPercent, cumulativeTFC, statePensionAge, statePension,
            earliestPensionWithdrawalAge, statePensionInflation, cashFlowDataAccumulation,
            taxFreeCashPercent
        ) {
            var tol = 0.01; // Tolerance for convergence
            var maxIter = 100;
            var iter = 0;

            var netIncomeLower = 0; // Lower bound of net income
            var yearsOfDrawdown = endAge - retirementAge + 1;

            // Calculate total available funds
            var totalAvailableFunds = fundAtRetirement + ISAAtRetirement;

            // For conservative estimation, set effectiveReturnRate to zero
            var effectiveReturnRate = 0;

            // Calculate upper bound for net income
            var netIncomeUpper;
            if (Math.abs(effectiveReturnRate) < 1e-8) {
                netIncomeUpper = statePension + totalAvailableFunds * Math.pow(1 + fundGrowthPost, yearsOfDrawdown) / yearsOfDrawdown;
            } else {
                var annuityFactor = (effectiveReturnRate * Math.pow(1 + effectiveReturnRate, yearsOfDrawdown)) / (Math.pow(1 + effectiveReturnRate, yearsOfDrawdown) - 1);
                netIncomeUpper = statePension + totalAvailableFunds * annuityFactor;
            }

            var acceptableEndBalance = 1000; // Minimum acceptable balance at end age to prevent depletion

            var maxAffordableNetIncome = 0;

            while (iter < maxIter) {
                maxAffordableNetIncome = (netIncomeLower + netIncomeUpper) / 2;
                var simulation = simulateCombinedFund(
                    currentAge, retirementAge, endAge, fundAtRetirement, ISAAtRetirement, fundGrowthPost, fundCharges,
                    inflation, remainingTFCPercent, cumulativeTFC, statePensionAge, statePension,
                    earliestPensionWithdrawalAge, maxAffordableNetIncome, statePensionInflation, cashFlowDataAccumulation,
                    taxFreeCashPercent, 268275
                );

                var finalBalance = simulation.finalBalance;
                var fundsDepletedBeforeEndAge = simulation.fundsDepletedBeforeEndAge;

                if (fundsDepletedBeforeEndAge || finalBalance < acceptableEndBalance) {
                    // Funds deplete before endAge or final balance is less than acceptable
                    netIncomeUpper = maxAffordableNetIncome;
                } else {
                    // Funds last until endAge with acceptable balance
                    netIncomeLower = maxAffordableNetIncome;
                }

                // Check for convergence
                if (Math.abs(netIncomeUpper - netIncomeLower) < tol || iter === maxIter - 1) {
                    break;
                }

                iter++;
            }

            return maxAffordableNetIncome;
        }


        function simulateCombinedFund(
            currentAge, retirementAge, endAge, fundAtRetirement, ISAAtRetirement, fundGrowthPost, fundCharges,
            inflation, remainingTFCPercent, cumulativeTFC, statePensionAge, statePension,
            earliestPensionWithdrawalAge, targetNetIncome, statePensionInflation, cashFlowDataAccumulation,
            taxFreeCashPercent, maxTFCAmount
        ) {
            var cashFlowData = [...cashFlowDataAccumulation];
            var ageWhenTFCMaxed = null;
            var statePensionInPayment = 0;
            var maxAge = endAge;

            var startAge = retirementAge;

            var fund = fundAtRetirement;
            var ISA = ISAAtRetirement;

            var fundsDepletedBeforeEndAge = false; // Flag to track early depletion

            var previousGrossPensionWithdrawal = 0; // Initialize previous gross pension withdrawal

            for (var age = startAge; age <= maxAge; age++) {
                var openingFundBalance = fund;
                var openingISABalance = ISA;

                // Adjust state pension each year
                if (age >= statePensionAge) {
                    statePensionInPayment = statePension * Math.pow(1 + statePensionInflation, age - statePensionAge);
                } else {
                    statePensionInPayment = 0;
                }

                var inflationAdjustedNetIncome = targetNetIncome * Math.pow(1 + inflation, age - retirementAge);

                var netIncomeNeededFromInvestments = inflationAdjustedNetIncome - statePensionInPayment;

                var netPensionWithdrawal = 0;
                var grossPensionWithdrawal = 0;
                var taxPaid = 0;
                var taxSaved = 0;
                var ISADrawings = 0;

                if (netIncomeNeededFromInvestments <= 0) {
                    // No withdrawals needed from investments
                    netIncomeNeededFromInvestments = 0;
                }

                // Adjust fund balance for TFC at earliestPensionWithdrawalAge
                if (age == earliestPensionWithdrawalAge && fund > 0) {
                    // Calculate TFC
                    var expectedTFC = fund * taxFreeCashPercent;
                    var taxFreeCashTaken = Math.min(expectedTFC, maxTFCAmount - cumulativeTFC);
                    fund = fund - taxFreeCashTaken;
                    cumulativeTFC += taxFreeCashTaken;
                    // Adjust remainingTFCPercent
                    remainingTFCPercent = 0.25 - (cumulativeTFC / (fund + cumulativeTFC || 1)); // Adjust for new fund value
                    remainingTFCPercent = Math.max(remainingTFCPercent, 0); // Ensure it does not go negative
                }

                // Calculate fund charges and investment gain
                var investmentGain = fund * fundGrowthPost;
                var fundChargesTaken = fund * fundCharges;

                // Determine gross pension and ISA withdrawal needed
                var iterations = 0;
                var iterationLimit = 100;
                var tolerance = 0.01;
                var fundExhausted = false;
                var ISAExhausted = false;

                var lowerGuess = 0;
                var upperGuess = fund; // Maximum possible gross pension withdrawal

                // Set initial guess for gross pension withdrawal
                if (age >= earliestPensionWithdrawalAge) {
                    // From age 57 onwards, prioritize pension withdrawals up to personal allowance
                    var adjustedPersonalAllowance = 12570;

                    // Calculate maximum taxable pension withdrawal to utilize personal allowance
                    var maxTaxablePensionWithdrawal = adjustedPersonalAllowance - statePensionInPayment;
                    maxTaxablePensionWithdrawal = Math.max(maxTaxablePensionWithdrawal, 0);

                    // Add back tax-free portion to get gross pension withdrawal
                    var maxGrossPensionWithdrawal = maxTaxablePensionWithdrawal / (1 - remainingTFCPercent);

                    // Ensure we don't withdraw more than needed
                    grossPensionWithdrawal = Math.min(maxGrossPensionWithdrawal, netIncomeNeededFromInvestments / (1 - remainingTFCPercent), fund);
                } else {
                    grossPensionWithdrawal = 0; // Before age 57, pension withdrawals are not possible
                }

                grossPensionWithdrawal = Math.min(Math.max(grossPensionWithdrawal, lowerGuess), upperGuess);

                while (iterations < iterationLimit) {
                    if (iterations > 0) {
                        // Adjust grossPensionWithdrawal using bisection method
                        grossPensionWithdrawal = (lowerGuess + upperGuess) / 2;
                    }

                    if (grossPensionWithdrawal >= fund) {
                        grossPensionWithdrawal = fund;
                        fundExhausted = true;
                    }

                    // Calculate tax-free portion
                    var taxFreePortion = grossPensionWithdrawal * remainingTFCPercent;

                    // Adjust for cumulative TFC limit
                    if (cumulativeTFC >= maxTFCAmount) {
                        taxFreePortion = 0;
                        remainingTFCPercent = 0;
                    } else if (cumulativeTFC + taxFreePortion > maxTFCAmount) {
                        taxFreePortion = maxTFCAmount - cumulativeTFC;
                        remainingTFCPercent = (maxTFCAmount - cumulativeTFC) / grossPensionWithdrawal;
                        remainingTFCPercent = Math.max(remainingTFCPercent, 0); // Ensure it does not go negative
                        if (ageWhenTFCMaxed === null) {
                            ageWhenTFCMaxed = age;
                        }
                    }

                    var taxablePortion = grossPensionWithdrawal - taxFreePortion;

                    // Total taxable income
                    var totalTaxableIncome = taxablePortion + statePensionInPayment;

                    // Calculate tax
                    var totalTax = calculateIncomeTax(totalTaxableIncome);
                    var statePensionTax = calculateIncomeTax(statePensionInPayment);
                    taxPaid = totalTax - statePensionTax;
                    taxPaid = Math.max(taxPaid, 0);

                    netPensionWithdrawal = grossPensionWithdrawal - taxPaid;

                    // Adjust netPensionWithdrawal if it becomes negative due to tax exceeding gross withdrawal
                    if (netPensionWithdrawal < 0) {
                        // Adjust state pension for tax
                        var statePensionAfterTax = statePensionInPayment - statePensionTax;
                        if (statePensionAfterTax < 0) {
                            statePensionAfterTax = 0;
                        }
                        netPensionWithdrawal = 0;
                        // Adjust net income needed from investments accordingly
                        netIncomeNeededFromInvestments = inflationAdjustedNetIncome - statePensionAfterTax;
                    }

                    // Calculate total net income from pension and state pension
                    var totalNetIncomeFromPension = netPensionWithdrawal + statePensionInPayment - statePensionTax;

                    // Determine ISA withdrawal needed
                    ISADrawings = netIncomeNeededFromInvestments - netPensionWithdrawal;
                    ISADrawings = Math.max(ISADrawings, 0);
                    if (ISADrawings >= ISA) {
                        ISADrawings = ISA;
                        ISAExhausted = true;
                    }

                    // Calculate total net income
                    var totalNetIncome = totalNetIncomeFromPension + ISADrawings;

                    // Check if total net income meets the required income
                    if (Math.abs(totalNetIncome - inflationAdjustedNetIncome) < tolerance) {
                        cumulativeTFC += taxFreePortion;
                        break;
                    }

                    if (totalNetIncome < inflationAdjustedNetIncome) {
                        if (fundExhausted && ISAExhausted) {
                            // Can't increase withdrawals, accept lower income
                            cumulativeTFC += taxFreePortion;
                            break;
                        } else {
                            lowerGuess = grossPensionWithdrawal;
                        }
                    } else {
                        upperGuess = grossPensionWithdrawal;
                    }

                    iterations++;
                }

                // Adjust fund balance
                fund = fund + investmentGain - grossPensionWithdrawal - fundChargesTaken;
                fund = Math.max(fund, 0);

                // Calculate ISA investment gain and charges
                var ISAGain = ISA * fundGrowthPost;
                var ISAChargesTaken = ISA * fundCharges;

                // Update ISA balance
                ISA = ISA + ISAGain - ISAChargesTaken - ISADrawings;
                ISA = Math.max(ISA, 0);

                taxSaved = taxFreePortion;

                cashFlowData.push({
                    age: age,
                    openingBalance: openingFundBalance,
                    contribution: 0,
                    withdrawal: netPensionWithdrawal,
                    statePension: statePensionInPayment - statePensionTax,
                    taxPaid: taxPaid + statePensionTax,
                    taxSaved: taxSaved,
                    cumulativeTFC: cumulativeTFC,
                    investmentReturn: investmentGain || 0,
                    fundCharges: fundChargesTaken || 0,
                    closingBalance: fund,
                    ISAholdings: ISA,
                    ISAContribution: 0,
                    ISADrawings: ISADrawings
                });

                previousGrossPensionWithdrawal = grossPensionWithdrawal; // Store for next iteration

                if (fund <= 0 && ISA <= 0) {
                    // Funds depleted before end age
                    if (age < endAge) {
                        fundsDepletedBeforeEndAge = true;
                    }
                    break; // Exit the loop early
                }
            }

            var finalBalance = fund + ISA;

            return {
                finalBalance: finalBalance,
                cashFlowData: cashFlowData,
                ageWhenTFCMaxed: ageWhenTFCMaxed,
                fundsDepletedBeforeEndAge: fundsDepletedBeforeEndAge // Return the flag
            };
        }






        function calculateIncomeTax(income) {
            // UK Income Tax Bands for 2023/24 (excluding Scotland)
            var personalAllowance = 12570;
            var basicRateLimit = 50270;
            var higherRateLimit = 125140; // Threshold for additional rate

            var basicRate = 0.20;
            var higherRate = 0.40;
            var additionalRate = 0.45;

            var totalIncome = income; // Assuming no other income sources
            var adjustedPersonalAllowance = personalAllowance;

            // Reduction of personal allowance for income over £100,000
            if (totalIncome > 100000) {
                var reduction = Math.min((totalIncome - 100000) / 2, personalAllowance);
                adjustedPersonalAllowance = personalAllowance - reduction;
            }

            var taxableIncome = Math.max(0, totalIncome - adjustedPersonalAllowance);
            var tax = 0;

            if (taxableIncome <= 0) {
                tax = 0;
            } else if (taxableIncome <= (basicRateLimit - adjustedPersonalAllowance)) {
                tax = taxableIncome * basicRate;
            } else if (taxableIncome <= (higherRateLimit - adjustedPersonalAllowance)) {
                tax = (basicRateLimit - adjustedPersonalAllowance) * basicRate;
                tax += (taxableIncome - (basicRateLimit - adjustedPersonalAllowance)) * higherRate;
            } else {
                tax = (basicRateLimit - adjustedPersonalAllowance) * basicRate;
                tax += (higherRateLimit - basicRateLimit) * higherRate;
                tax += (taxableIncome - (higherRateLimit - adjustedPersonalAllowance)) * additionalRate;
            }

            return tax;
        }

        function getStatePensionAge(currentAge) {
            const currentYear = new Date().getFullYear();
            const birthYear = currentYear - currentAge;

            if (birthYear < 1954) {
                return 65;  // State Pension age for men born before 6 December 1953
            } else if (birthYear >= 1954 && birthYear <= 1960) {
                return 66;  // State Pension age for men born between 6 December 1953 and 5 April 1960
            } else if (birthYear >= 1961 && birthYear <= 1977) {
                return 67;  // State Pension age for men born between 6 April 1960 and 5 April 1977
            } else if (birthYear >= 1978) {
                return 68;  // Expected State Pension age for men born on or after 6 April 1977
            } else {
                return "Unknown";
            }
        }

        function calculateStatePension(currentAge, currentPension, statePensionInflation) {
            const pensionAge = getStatePensionAge(currentAge);

            if (typeof pensionAge === "string") {
                return "Pension age unknown";
            }

            if (currentAge >= pensionAge) {
                return currentPension;
            }

            const yearsToPension = pensionAge - currentAge;

            let futurePension = currentPension;

            // Apply annual increase for each year until State Pension age
            for (let i = 0; i < yearsToPension; i++) {
                futurePension *= (1 + statePensionInflation);
            }

            return futurePension;  // Returns the future state pension
        }

        function plotChart(simulation) {
            var ctx = document.getElementById('fundChart').getContext('2d');
            var chartData = {
                labels: simulation.cashFlowData.map(data => data.age),
                datasets: [
                    {
                        label: 'Pension Fund Value (£)',
                        data: simulation.cashFlowData.map(data => data.closingBalance),
                        borderColor: '#1E88E5', // Brighter blue for the line
                        backgroundColor: 'rgba(30, 136, 229, 0.2)', // Light blue with transparency
                        fill: true,
                        tension: 0.1
                    },
                    {
                        label: 'ISA Holdings (£)',
                        data: simulation.cashFlowData.map(data => data.ISAholdings),
                        borderColor: '#FF8C00', // Brighter orange for the line
                        backgroundColor: 'rgba(255, 140, 0, 0.2)', // Light orange 
                        fill: true,
                        tension: 0.1
                    }
                ]
            };

            if (window.myLineChart) {
                window.myLineChart.destroy();
            }

            window.myLineChart = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Age'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Fund Value (£)'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // New function to plot the income breakdown chart
        function plotIncomeChart(simulation) {
            var ctx = document.getElementById('incomeChart').getContext('2d');
            var ages = simulation.cashFlowData.map(data => data.age);
            var netPensionWithdrawals = simulation.cashFlowData.map(data => data.withdrawal);
            var ISADrawings = simulation.cashFlowData.map(data => data.ISADrawings);
            var statePensions = simulation.cashFlowData.map(data => data.statePension);

            // Only include ages in retirement
            var retirementData = simulation.cashFlowData.filter(data => data.age >= simulation.cashFlowData[0].age);

            ages = retirementData.map(data => data.age);
            netPensionWithdrawals = retirementData.map(data => data.withdrawal);
            ISADrawings = retirementData.map(data => data.ISADrawings);
            statePensions = retirementData.map(data => data.statePension);

            if (window.myIncomeChart) {
                window.myIncomeChart.destroy();
            }

            window.myIncomeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ages,
                    datasets: [
                        {
                            label: 'State Pension (£)',
                            data: statePensions,
                            backgroundColor: '#4CAF50' // Green
                        },
                        {
                            label: 'ISA Withdrawals (£)',
                            data: ISADrawings,
                            backgroundColor: '#FF9800' // Orange
                        },
                        {
                            label: 'Net Pension Withdrawals (£)',
                            data: netPensionWithdrawals,
                            backgroundColor: '#2196F3' // Blue
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        x: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Age'
                            }
                        },
                        y: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Annual Income (£)'
                            },
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    var label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += '£' + formatNumber(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        function displayCashFlowTable(cashFlowData) {
            var tableBody = document.getElementById('cashFlowTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = ''; // Clear previous data

            cashFlowData.forEach(function (row) {
                var tr = document.createElement('tr');

                var tdAge = document.createElement('td');
                tdAge.textContent = row.age;
                tr.appendChild(tdAge);

                var tdOpening = document.createElement('td');
                tdOpening.textContent = '£' + formatNumber(Math.round(row.openingBalance));
                tr.appendChild(tdOpening);

                var tdContribution = document.createElement('td');
                tdContribution.textContent = '£' + formatNumber(Math.round(row.contribution));
                tr.appendChild(tdContribution);

                var tdWithdrawal = document.createElement('td');
                tdWithdrawal.textContent = '£' + formatNumber(Math.round(row.withdrawal));
                tr.appendChild(tdWithdrawal);

                var tdStatePension = document.createElement('td');
                tdStatePension.textContent = '£' + formatNumber(Math.round(row.statePension));
                tr.appendChild(tdStatePension);

                var tdTaxPaid = document.createElement('td');
                tdTaxPaid.textContent = '£' + formatNumber(Math.round(row.taxPaid));
                tr.appendChild(tdTaxPaid);

                var tdTaxSaved = document.createElement('td');
                tdTaxSaved.textContent = '£' + formatNumber(Math.round(row.taxSaved));
                tr.appendChild(tdTaxSaved);

                var tdCumulativeTFC = document.createElement('td');
                tdCumulativeTFC.textContent = '£' + formatNumber(Math.round(row.cumulativeTFC));
                tr.appendChild(tdCumulativeTFC);

                var tdInvestmentReturn = document.createElement('td');
                tdInvestmentReturn.textContent = '£' + formatNumber(Math.round(row.investmentReturn || 0));
                tr.appendChild(tdInvestmentReturn);

                var tdFundCharges = document.createElement('td');
                tdFundCharges.textContent = '£' + formatNumber(Math.round(row.fundCharges || 0));
                tr.appendChild(tdFundCharges);

                var tdISAholdings = document.createElement('td');
                tdISAholdings.textContent = '£' + formatNumber(Math.round(row.ISAholdings));
                tr.appendChild(tdISAholdings);

                var tdISAContribution = document.createElement('td');
                tdISAContribution.textContent = '£' + formatNumber(Math.round(row.ISAContribution));
                tr.appendChild(tdISAContribution);

                var tdISADrawings = document.createElement('td');
                tdISADrawings.textContent = '£' + formatNumber(Math.round(row.ISADrawings));
                tr.appendChild(tdISADrawings);

                var totalNetIncome = row.withdrawal + row.statePension + row.ISADrawings;

                var tdTotalNetIncome = document.createElement('td');
                tdTotalNetIncome.textContent = '£' + formatNumber(Math.round(totalNetIncome));
                tr.appendChild(tdTotalNetIncome);

                tableBody.appendChild(tr);
            });
        }

        function formatNumber(num) {
            return num.toLocaleString('en-UK');
        }
    </script>
</body>
</html>
